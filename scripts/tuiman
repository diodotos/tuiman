#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_DIR=""

if [ -d "${SCRIPT_DIR}/frontend" ]; then
  APP_DIR="${SCRIPT_DIR}/frontend"
elif [ -d "${SCRIPT_DIR}/../frontend" ]; then
  APP_DIR="${SCRIPT_DIR}/../frontend"
fi

if [ -z "${APP_DIR}" ] || [ ! -f "${APP_DIR}/src/index.tsx" ]; then
  echo "Expected frontend sources next to launcher or in ../frontend" >&2
  exit 1
fi

if [ "${1:-}" = "--version" ] || [ "${1:-}" = "-v" ]; then
  bun -e 'const p = JSON.parse(await Bun.file(process.argv[1]).text()); console.log(p.version);' "${APP_DIR}/package.json"
  exit 0
fi

if [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
  cat <<EOF
tuiman
Usage: tuiman [--help] [--version]

Runs the OpenTUI TypeScript client.
EOF
  exit 0
fi

if [ ! -d "${APP_DIR}/node_modules" ]; then
  bun install --cwd "${APP_DIR}"
fi

exec bun run --cwd "${APP_DIR}" src/index.tsx
